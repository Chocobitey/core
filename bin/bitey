#!/usr/bin/env ruby
require 'fileutils'
require 'open3'

# --- Config ---
BITEY_ROOT = "/opt/bitey"
PROGRAMS_DIR = "#{BITEY_ROOT}/programs"
GHCR_BASE = "https://ghcr.io/v2"

# --- Helpers ---

def sh(cmd)
  puts "ğŸ› ï¸  #{cmd}"
  system(cmd) || abort("âŒ Command failed: #{cmd}")
end

def download_package(user, repo, package, version)
  url = "#{GHCR_BASE}/#{user}/#{repo}/#{package}/#{package}-#{version}.choco.pkg"
  dest = "/tmp/#{package}-#{version}.choco.pkg"
  puts "ğŸ“¦ Downloading #{url}..."
  sh("curl --progress-bar -L #{url} -o #{dest}")
  dest
end

def install_package(archive, package)
  target = "#{PROGRAMS_DIR}/#{package}"
  FileUtils.mkdir_p(target)
  puts "ğŸš€ Installing..."
  sh("tar -xzf #{archive} -C #{target}")
  sh("chmod +x #{target}/bin/*")
end

# --- Main Logic ---

if ARGV[0] == "install" && ARGV[1]
  pkg = ARGV[1]            # e.g., "dev123/myrepo/hello"
  version = ARGV[2] || "1.0.0"
  user, repo, name = pkg.split("/")
  abort("âŒ Invalid format. Use user/repo/name") unless name

  puts "ğŸ¶ Installing #{name} v#{version}..."
  FileUtils.mkdir_p(PROGRAMS_DIR)
  file = download_package(user, repo, name, version)
  install_package(file, name)
  puts "ğŸ« Done! Bitzy fetched you a treat."

else
  puts <<~USAGE
    ğŸ« Bitey 1.0.0 â€” Chocobitey Package Manager
    Usage:
      bitey install <user>/<repo>/<package> [version]
  USAGE
end
